name: Notify subscribers

on:
  schedule:
    # 09:00, 20:00 JST
    - cron: '0 9,20 * * *'
      timezone: Asia/Tokyo
  workflow_dispatch:

concurrency:
  group: yt-notifier
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check out footprints repository
        uses: actions/checkout@v4
        with:
          repository: hellomyzn/footprints
          path: footprints
          token: ${{ secrets.FOOTPRINTS_TOKEN }}
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: src/go.mod
      - name: Create .env files
        run: |
          echo "${{ secrets.ENV_WEBHOOKS }}" > src/config/webhooks.env
          echo "${{ secrets.ENV_YOUTUBE }}" > src/config/youtube.env
      - name: Sync CSV from footprints repository
        run: |
          pwd
          rm -rf src/src/csv/*
          cp footprints/rss/* src/src/csv/
          ls src/src/csv/
      - name: Run notifier job
        working-directory: src
        env:
          TZ: Asia/Tokyo
        run: go run ./cmd/job
      - name: Sync CSV back to footprints repository
        run: |
          rm -rf footprints/rss/*
          cp src/src/csv/* footprints/rss/
      - name: Commit CSV updates
        working-directory: footprints
        env:
          GIT_AUTHOR_NAME: ${{ secrets.FOOTPRINTS_AUTHOR_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.FOOTPRINTS_AUTHOR_EMAIL }}
          GIT_COMMITTER_NAME: ${{ secrets.FOOTPRINTS_AUTHOR_NAME }}
          GIT_COMMITTER_EMAIL: ${{ secrets.FOOTPRINTS_AUTHOR_EMAIL }}
        run: |
          if ! git diff --quiet; then
            git add .
            git commit -m "Update rss from yt-notifier"
            git push
          fi
